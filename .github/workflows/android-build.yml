name: Child App CI Build (Fixed)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Generate Full Child Project (Fixed)
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        mkdir -p app/src/main/assets
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/xml
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/java/com/abuzahra/tracker
        
        # === 1. Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©) ===
        
        # settings.gradle
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "AbuAlZahra-Child"
        include ':app'
        EOF

        # build.gradle (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
        cat > build.gradle << 'EOF'
        plugins {
            id 'com.android.application' version '8.2.0' apply false
            id 'org.jetbrains.kotlin.android' version '1.9.0' apply false
            id 'com.google.gms.google-services' version '4.4.0' apply false
        }
        EOF

        # app/build.gradle (Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
            id 'org.jetbrains.kotlin.android'
            id 'com.google.gms.google-services'
        }
        android {
            namespace 'com.abuzahra.tracker'
            compileSdk 34
            defaultConfig {
                applicationId "com.abuzahra.tracker"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }
            buildTypes { release { minifyEnabled false } }
            compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }
            kotlinOptions { jvmTarget = '1.8' }
        }
        dependencies {
            implementation 'androidx.core:core-ktx:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
            
            // Firebase & WorkManager
            implementation platform('com.google.firebase:firebase-bom:32.7.2')
            implementation 'com.google.firebase:firebase-auth-ktx'
            implementation 'com.google.firebase:firebase-firestore-ktx'
            implementation 'androidx.work:work-runtime-ktx:2.8.1'
            implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3'
        }
        EOF
        
        # gradle.properties
        echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8\nandroid.useAndroidX=true" > gradle.properties

        # === 2. Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª ===

        # AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android" xmlns:tools="http://schemas.android.com/tools">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
            <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
            <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
            <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
            <uses-permission android:name="android.permission.PACKAGE_USAGE_STATS" tools:ignore="ProtectedPermissions" />
            <application
                android:allowBackup="true"
                android:icon="@android:drawable/ic_menu_manage"
                android:label="@string/app_name"
                android:roundIcon="@android:drawable/ic_menu_manage"
                android:supportsRtl="true"
                android:theme="@style/Theme.Abualzahra"
                android:networkSecurityConfig="@xml/network_security_config"
                tools:targetApi="31">
                <activity android:name=".MainActivity" android:exported="true" android:configChanges="orientation|screenSize" android:theme="@style/Theme.Abualzahra">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
                <service android:name=".services.MyAccessibilityService" android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE" android:exported="true">
                    <intent-filter><action android:name="android.accessibilityservice.AccessibilityService" /></intent-filter>
                    <meta-data android:name="android.accessibilityservice" android:resource="@xml/accessibility_service_config" />
                </service>
                <service android:name=".services.MyNotificationListener" android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE" android:exported="true">
                    <intent-filter><action android:name="android.service.notification.NotificationListenerService" /></intent-filter>
                </service>
            </application>
        </manifest>
        EOF

        # google-services.json
        cat > app/google-services.json << 'EOF'
        { "project_info": { "project_number": "787676787951", "project_id": "studio-7073076148-6afe0" }, "client": [ { "client_info": { "mobilesdk_app_id": "1:787676787951:android:bc4742c2e9921c5194171a", "android_client_info": { "package_name": "com.abuzahra.tracker" } }, "api_key": [ { "current_key": "AIzaSyASBVIQ0AvrsLqAgbT9k6L7bCpZKoqdvjo" } ] } ] }
        EOF

        # Resources
        echo "<resources><string name=\"app_name\">Abu Al-Zahra Child</string></resources>" > app/src/main/res/values/strings.xml
        cat > app/src/main/res/values/styles.xml << 'EOF'
        <resources><style name="Theme.Abualzahra" parent="Theme.MaterialComponents.DayNight.NoActionBar"><item name="colorPrimary">#2563EB</item><item name="android:statusBarColor">#0F172A</item><item name="android:windowBackground">#0F172A</item></style></resources>
        EOF
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><network-security-config><base-config cleartextTrafficPermitted=\"true\"><trust-anchors><certificates src=\"system\"/></trust-anchors></base-config></network-security-config>" > app/src/main/res/xml/network_security_config.xml
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><full-backup-content><include domain=\"sharedpref\" path=\".\"/></full-backup-content>" > app/src/main/res/xml/backup_rules.xml
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><data-extraction-rules><cloud-backup><include domain=\"sharedpref\" path=\".\"/></cloud-backup></data-extraction-rules>" > app/src/main/res/xml/data_extraction_rules.xml
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><accessibility-service xmlns:android=\"http://schemas.android.com/apk/res/android\" android:description=\"@string/app_name\" android:accessibilityEventTypes=\"typeAllMask\" android:accessibilityFeedbackType=\"feedbackGeneric\" android:canRetrieveWindowContent=\"true\" />" > app/src/main/res/xml/accessibility_service_config.xml
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><RelativeLayout xmlns:android=\"http://schemas.android.com/apk/res/android\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:background=\"#0F172A\"><WebView android:id=\"@+id/webview\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" /></RelativeLayout>" > app/src/main/res/layout/activity_main.xml

        # HTML
        cat > app/src/main/assets/child_index.html << 'HTMLEOF'
        <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"></script><link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet"><style>body{font-family:'Tajawal',sans-serif;background-color:#0F172A;color:#fff}.screen{display:none;position:fixed;inset:0;flex-direction:column}.screen.active{display:flex}</style></head><body>
        <div id="screen-binding" class="screen active items-center justify-center bg-white"><div class="w-full max-w-sm text-center p-6"><div class="w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center"><span class="text-3xl">ğŸ”—</span></div><h2 class="text-xl font-bold text-gray-800 mb-2">Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø±Ø¨Ø·</h2><p class="text-gray-500 text-sm mb-6">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…</p><div id="code-container" class="flex justify-center mb-4 direction-ltr"></div><button id="btn-confirm" onclick="confirmBinding()" disabled class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold opacity-50">Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²</button><p id="error-msg" class="text-red-500 text-xs mt-2 hidden"></p></div></div>
        <div id="screen-permissions" class="screen bg-gray-100"><div class="bg-white p-4 border-b shadow-sm"><h2 class="text-lg font-bold text-center text-gray-800">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h2></div><div class="flex-1 overflow-y-auto p-4 space-y-3">
        <div class="bg-white rounded-xl p-3 flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">ğŸ”’</div><div class="flex-1"><h3 class="font-bold text-sm text-gray-700">Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆØµÙˆÙ„</h3></div><button onclick="togglePerm('accessibility')" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg font-bold">ØªÙØ¹ÙŠÙ„</button></div>
        <div class="bg-white rounded-xl p-3 flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">ğŸ“Š</div><div class="flex-1"><h3 class="font-bold text-sm text-gray-700">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3></div><button onclick="togglePerm('usage')" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg font-bold">ØªÙØ¹ÙŠÙ„</button></div>
        <div class="bg-white rounded-xl p-3 flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">ğŸ“</div><div class="flex-1"><h3 class="font-bold text-sm text-gray-700">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</h3></div><button onclick="togglePerm('location')" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg font-bold">ØªÙØ¹ÙŠÙ„</button></div>
        <div class="bg-white rounded-xl p-3 flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">ğŸ‘ï¸</div><div class="flex-1"><h3 class="font-bold text-sm text-gray-700">Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</h3></div><button onclick="togglePerm('overlay')" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg font-bold">ØªÙØ¹ÙŠÙ„</button></div>
        </div><div class="p-4 bg-white border-t"><button onclick="finishSetup()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">ØªÙ…ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ù…Ø§ÙŠØ©</button></div></div>
        <div id="screen-success" class="screen items-center justify-center bg-green-50 p-6"><div class="text-center"><div class="w-20 h-20 bg-green-500 rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg"><span class="text-4xl text-white">âœ“</span></div><h2 class="text-2xl font-bold text-gray-800 mb-2">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</h2><p class="text-gray-600 text-sm mb-6">Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø±Ø¨ÙˆØ· ÙˆÙ…Ø­Ù…ÙŠ.</p></div></div>
        <script>
        function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function callNative(fn, arg){ if(typeof AndroidNative!=='undefined'){ arg ? AndroidNative[fn](arg) : AndroidNative[fn](); } }
        const codeContainer = document.getElementById('code-container'); for(let i=0; i<9; i++){ let input = document.createElement('input'); input.type = 'number'; input.className = 'code-input'; input.maxLength = 1; input.style.cssText = "width:30px;height:40px;text-align:center;font-size:18px;font-weight:bold;border:2px solid #E5E7EB;border-radius:6px;outline:none;margin:2px"; input.oninput = (e) => handleCodeInput(e, i); codeContainer.appendChild(input); }
        function handleCodeInput(e, index) { const inputs = codeContainer.getElementsByTagName('input'); if(e.target.value.length === 1 && index < 8) inputs[index+1].focus(); checkCodeComplete(); }
        function checkCodeComplete() { const inputs = codeContainer.getElementsByTagName('input'); let code = ""; for(let inp of inputs) code += inp.value; const btn = document.getElementById('btn-confirm'); if(code.length === 9) { btn.disabled = false; btn.classList.remove('opacity-50'); } else { btn.disabled = true; btn.classList.add('opacity-50'); } }
        function confirmBinding() { const inputs = codeContainer.getElementsByTagName('input'); let code = ""; for(let inp of inputs) code += inp.value; document.getElementById('error-msg').classList.add('hidden'); callNative('linkDevice', code); }
        function togglePerm(type){ callNative('requestPermission', type); }
        function finishSetup(){ callNative('startServices'); showScreen('screen-success'); }
        window.onLinkSuccess = function(){ showScreen('screen-permissions'); };
        window.onLinkError = function(msg){ document.getElementById('error-msg').innerText = msg; document.getElementById('error-msg').classList.remove('hidden'); };
        </script></body></html>
        HTMLEOF

        # Kotlin Files
        cat > app/src/main/java/com/abuzahra/tracker/MainActivity.kt << 'EOF'
        package com.abuzahra.tracker
        import android.Manifest
        import android.content.pm.PackageManager
        import android.os.Bundle
        import android.webkit.WebSettings
        import android.webkit.WebView
        import android.webkit.WebViewClient
        import androidx.appcompat.app.AppCompatActivity
        import androidx.core.app.ActivityCompat
        import androidx.core.content.ContextCompat
        import androidx.work.ExistingPeriodicWorkPolicy
        import androidx.work.PeriodicWorkRequestBuilder
        import androidx.work.WorkManager
        import java.util.concurrent.TimeUnit
        class MainActivity : AppCompatActivity() {
            lateinit var webView: WebView
            private val PERMISSIONS_REQUEST_CODE = 101
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_main)
                requestPermissions()
                webView = findViewById(R.id.webview)
                val webSettings: WebSettings = webView.settings
                webSettings.javaScriptEnabled = true
                webSettings.domStorageEnabled = true
                webView.addJavascriptInterface(ChildWebInterface(this), "AndroidNative")
                webView.webViewClient = WebViewClient()
                webView.loadUrl("file:///android_asset/child_index.html")
            }
            private fun requestPermissions() {
                val permissions = arrayOf(Manifest.permission.ACCESS_FINE_LOCATION, Manifest.permission.ACCESS_COARSE_LOCATION)
                val needed = permissions.filter { ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED }
                if (needed.isNotEmpty()) ActivityCompat.requestPermissions(this, needed.toTypedArray(), PERMISSIONS_REQUEST_CODE)
            }
            fun startWorker() {
                val workRequest = PeriodicWorkRequestBuilder<StatusWorker>(15, TimeUnit.MINUTES).build()
                WorkManager.getInstance(this).enqueueUniquePeriodicWork("status_work", ExistingPeriodicWorkPolicy.KEEP, workRequest)
            }
        }
        EOF

        cat > app/src/main/java/com/abuzahra/tracker/ChildWebInterface.kt << 'EOF'
        package com.abuzahra.tracker
        import android.content.Context
        import android.content.Intent
        import android.provider.Settings
        import android.webkit.JavascriptInterface
        import com.google.firebase.auth.FirebaseAuth
        import com.google.firebase.firestore.FirebaseFirestore
        import kotlinx.coroutines.CoroutineScope
        import kotlinx.coroutines.Dispatchers
        import kotlinx.coroutines.launch
        import kotlinx.coroutines.tasks.await
        class ChildWebInterface(private val mContext: Context) {
            private val auth = FirebaseAuth.getInstance()
            private val db = FirebaseFirestore.getInstance()
            @JavascriptInterface
            fun linkDevice(code: String) {
                CoroutineScope(Dispatchers.IO).launch {
                    try {
                        val doc = db.collection("linking_codes").document(code).get().await()
                        if (!doc.exists()) { sendResult("window.onLinkError('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­')"); return@launch }
                        val parentUid = doc.getString("parent_uid") ?: ""
                        val deviceId = Settings.Secure.getString(mContext.contentResolver, Settings.Secure.ANDROID_ID)
                        if (auth.currentUser == null) auth.signInAnonymously().await()
                        val data = mapOf("device_id" to deviceId, "last_seen" to System.currentTimeMillis(), "battery_level" to 100)
                        db.collection("parents").document(parentUid).collection("children").document(deviceId).set(data).await()
                        db.collection("linking_codes").document(code).delete().await()
                        SharedPrefsManager.saveData(mContext, parentUid, deviceId)
                        sendResult("window.onLinkSuccess()")
                    } catch (e: Exception) { sendResult("window.onLinkError('Ø®Ø·Ø£: ${e.message}')") }
                }
            }
            @JavascriptInterface
            fun requestPermission(type: String) {
                when (type) {
                    "accessibility" -> mContext.startActivity(Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
                    "usage" -> mContext.startActivity(Intent(Settings.ACTION_USAGE_ACCESS_SETTINGS).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
                    "location" -> mContext.startActivity(Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
                    "overlay" -> mContext.startActivity(Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
                }
            }
            @JavascriptInterface
            fun startServices() { (mContext as MainActivity).startWorker() }
            private fun sendResult(js: String) { CoroutineScope(Dispatchers.Main).launch { (mContext as MainActivity).webView.evaluateJavascript(js, null) } }
        }
        EOF

        cat > app/src/main/java/com/abuzahra/tracker/SharedPrefsManager.kt << 'EOF'
        package com.abuzahra.tracker
        import android.content.Context
        object SharedPrefsManager {
            private const val PREFS = "child_prefs"
            fun saveData(ctx: Context, parentUid: String, deviceId: String) { ctx.getSharedPreferences(PREFS, Context.MODE_PRIVATE).edit().apply { putString("parent_uid", parentUid); putString("device_id", deviceId); apply() } }
            fun getParentUid(ctx: Context): String? = ctx.getSharedPreferences(PREFS, Context.MODE_PRIVATE).getString("parent_uid", null)
            fun getDeviceId(ctx: Context): String? = ctx.getSharedPreferences(PREFS, Context.MODE_PRIVATE).getString("device_id", null)
        }
        EOF

        cat > app/src/main/java/com/abuzahra/tracker/StatusWorker.kt << 'EOF'
        package com.abuzahra.tracker
        import android.content.Context
        import android.os.BatteryManager
        import androidx.work.CoroutineWorker
        import androidx.work.WorkerParameters
        import com.google.firebase.firestore.FirebaseFirestore
        import kotlinx.coroutines.tasks.await
        class StatusWorker(ctx: Context, params: WorkerParameters) : CoroutineWorker(ctx, params) {
            override suspend fun doWork(): Result {
                try {
                    val parentUid = SharedPrefsManager.getParentUid(applicationContext) ?: return Result.failure()
                    val deviceId = SharedPrefsManager.getDeviceId(applicationContext) ?: return Result.failure()
                    val battery = (applicationContext.getSystemService(Context.BATTERY_SERVICE) as BatteryManager).getIntProperty(BatteryManager.BATTERY_PROPERTY_CAPACITY)
                    val data = mapOf("battery_level" to battery, "last_seen" to System.currentTimeMillis())
                    FirebaseFirestore.getInstance().collection("parents").document(parentUid).collection("children").document(deviceId).update(data).await()
                    return Result.success()
                } catch (e: Exception) { return Result.retry() }
            }
        }
        EOF

    # === Ø§Ù„Ø¨Ù†Ø§Ø¡ ===
    - name: Install Gradle and Build
      run: |
        curl -L https://services.gradle.org/distributions/gradle-8.5-bin.zip -o gradle-8.5-bin.zip
        unzip gradle-8.5-bin.zip
        export PATH=$PWD/gradle-8.5/bin:$PATH
        gradle wrapper
        ./gradlew :app:assembleDebug
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: AbuAlZahra-Child-App
        path: app/build/outputs/apk/debug/app-debug.apk
